/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'org.chuma.homecontroller.java-application-conventions'
    id 'eclipse'
}

dependencies {
    implementation project(':controller')
    implementation project(':extensions')

    implementation 'ch.qos.logback:logback-classic'
    implementation group: 'org.eclipse.jetty', name: 'jetty-server'
    implementation group: 'org.eclipse.jetty.websocket', name: 'websocket-api'
    implementation group: 'org.eclipse.jetty.websocket', name: 'websocket-server'
    implementation group: 'org.apache.commons', name: 'commons-lang3'
    implementation 'org.chuma.hvac-controller:hvac-controller'

    winRxtx group: 'org.rxtx', name: 'rxtx', classifier: 'win64', ext: 'dll'
}

application {
    // Define the main class for the application.
    mainClass = 'org.chuma.homecontroller.app.Main'
    applicationName = "home-controller"
}

run {
    systemProperty "java.library.path", "build/native"
}

startScripts {
    doLast {
        // add rxtxSerial.dll to windows lib path
        // it is expected that rxtx is already installed on linux
        var debugOption = '-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=6070'
        windowsScript.text = windowsScript.text.replace('set DEFAULT_JVM_OPTS=', "set DEFAULT_JVM_OPTS=\"-Djava.library.path=%APP_HOME%\\lib ${debugOption}\"")
        unixScript.text = unixScript.text.replace('DEFAULT_JVM_OPTS=""', "DEFAULT_JVM_OPTS=\"-Djava.library.path=/usr/lib/jni ${debugOption}\"")
    }
}

distZip {
    into("$application.applicationName-$project.version/lib") {
        from configurations.winRxtx
        rename { String fileName ->
            fileName = "rxtxSerial.dll"
        }
    }
}


task copyRxtxSerial(type: Sync) {
    from configurations.winRxtx
    rename { String fileName ->
        fileName = "rxtxSerial.dll"
    }
    into "build/native/"
}

compileJava {
    dependsOn copyRxtxSerial
}